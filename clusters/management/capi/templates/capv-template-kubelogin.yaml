apiVersion: templates.weave.works/v1alpha2
kind: GitOpsTemplate
metadata:
  name: cluster-template-development-plus-kubelogin
  namespace: default
  annotations:
    templates.weave.works/add-common-bases: "true"
    templates.weave.works/inject-prune-annotations: "true"
  labels:
    weave.works/template-type: cluster
spec:
  description: A simple VCluster template
  params:
    - name: CLUSTER_NAME
      required: true
      description: This is used for the cluster naming.
    - name: NAMESPACE
      description: Namespace to create the cluster in
    - name: KUBERNETES_VERSION
      description: Kubernetes version to use for the cluster
      options: ["1.21", "1.22", "1.23", "1.24", "1.25", "1.26"]
    - name: K3S_VERSION
      description: Kubernetes version to use for the cluster
      options: ["v1.21.14-k3s1", "v1.22.15-k3s1", "v1.23.16-k3s1", "v1.24.10-k3s1", "v1.25.6-k3s1", "v1.26.1-k3s1"]
  resourcetemplates:
  - content:
    - apiVersion: gitops.weave.works/v1alpha1
      kind: GitopsCluster
      metadata:
        name: "${CLUSTER_NAME}"
        namespace: "${NAMESPACE}"
        labels:
          weave.works/capi: bootstrap
      spec:
        capiClusterRef:
          name: "${CLUSTER_NAME}"
    - apiVersion: cluster.x-k8s.io/v1beta1
      kind: Cluster
      metadata:
        name: "${CLUSTER_NAME}"
        namespace: "${NAMESPACE}"
      spec:
        controlPlaneRef:
          apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
          kind: VCluster
          name: "${CLUSTER_NAME}"
        infrastructureRef:
          apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
          kind: VCluster
          name: "${CLUSTER_NAME}"
    - apiVersion: infrastructure.cluster.x-k8s.io/v1alpha1
      kind: VCluster
      metadata:
        labels:
          cluster.x-k8s.io/cluster-name: "${CLUSTER_NAME}"
        name: "${CLUSTER_NAME}"
        namespace: "${NAMESPACE}"
      spec:
        controlPlaneEndpoint:
          host: "${CLUSTER_NAME}.turkey.local"
          port: 443
        kubernetesVersion: "\"${KUBERNETES_VERSION}\""
        helmRelease:
          values: |-
            vcluster:
              image: "rancher/k3s:${K3S_VERSION}"
              extraArgs:
              - --kube-apiserver-arg --oidc-issuer-url=https://dex.howard.moomboo.space
              - --kube-apiserver-arg --oidc-client-id=weave-gitops
              - --kube-apiserver-arg --oidc-groups-claim=groups
            syncer:
              extraArgs:
              - "--tls-san=${CLUSTER_NAME}.turkey.local"
            sync:
              nodes:
                enabled: true
              persistentvolumes:
                enabled: true
              # If you want to create custom storage classes
              # inside the vcluster.
              storageclasses:
                enabled: true
              ingresses:
                enabled: true
